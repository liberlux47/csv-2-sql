<!DOCTYPE html>
{% load dict_filters %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Firefox compatibility -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>Edit Table - {{ csv_upload.table_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .table-scroll {
            max-width: 100%;
            overflow-x: auto;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
            padding: 8px 12px;
            min-height: 40px;
            transition: background-color 0.2s;
        }
        
        .editable-cell:hover {
            background-color: #f8f9fa;
        }
        
        .editable-cell.editing {
            background-color: #fff3cd;
            padding: 0;
        }
        
        .cell-input {
            border: none;
            background: transparent;
            width: 100%;
            height: 100%;
            padding: 8px 12px;
            font-size: 0.875rem;
        }
        
        .cell-input:focus {
            outline: 2px solid #0d6efd;
            outline-offset: -2px;
        }
        
        .modified-cell {
            background-color: #d1ecf1 !important;
            border-left: 3px solid #0dcaf0;
        }
        
        .sort-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        .sort-header:hover {
            background-color: #495057;
        }
        
        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        
        .sort-header.active .sort-icon {
            opacity: 1;
        }
        
        .toolbar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .pagination-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 15px;
            margin-top: 20px;
        }
        
        .page-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .pending-changes {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 10px 15px;
            margin-bottom: 15px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Edit Table: {{ csv_upload.table_name }}</h2>
                <small class="text-muted">
                    Source: {{ csv_upload.filename }} | 
                    Total Records: <span id="total-records">{{ total_records }}</span>
                </small>
            </div>
            <a href="{% url 'csv_upload:upload' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Upload
            </a>
        </div>

        <!-- Pending Changes Alert -->
        <div id="pending-changes" class="pending-changes" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <strong>Unsaved Changes:</strong> <span id="pending-count">0</span> cell(s) modified
                </span>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="row g-3 align-items-center">
                <!-- Save/Undo Buttons -->
                <div class="col-auto">
                    <div class="btn-group">
                        <button id="save-changes" class="btn btn-success" disabled>
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button id="undo-changes" class="btn btn-warning" disabled>
                            <i class="fas fa-undo"></i> Undo Changes
                        </button>
                    </div>
                </div>

                <!-- Reload Button -->
                <div class="col-auto">
                    <button id="reload-table" class="btn btn-outline-primary">
                        <i class="fas fa-refresh"></i> Reload
                    </button>
                </div>

                <!-- Filter -->
                <div class="col-auto">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-filter"></i>
                        </span>
                        <input type="text" id="filter-input" class="form-control" 
                               placeholder="Filter records..." value="{{ filter_text }}">
                        <button class="btn btn-outline-secondary" id="clear-filter">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Page Size -->
                <div class="col-auto">
                    <div class="input-group">
                        <span class="input-group-text">Rows:</span>
                        <select id="page-size" class="form-select" style="min-width: 80px;">
                            {% for size in page_size_options %}
                                <option value="{{ size }}" {% if size == page_size %}selected{% endif %}>{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-container">
                    <div class="table-scroll">
                        <table class="table table-striped table-hover mb-0" id="data-table">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 80px;">Row #</th>
                                    {% for column, data_type in columns.items %}
                                        <th class="sort-header" data-column="{{ column }}" 
                                            data-current-sort="{% if sort_by == column %}{{ sort_order }}{% endif %}">
                                            {{ column|title }}
                                            <small class="d-block text-muted">({{ data_type }})</small>
                                            <i class="fas fa-sort sort-icon {% if sort_by == column %}active{% endif %}" 
                                               data-sort-direction="{{ sort_order }}"></i>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                {% for row in table_data %}
                                    <tr data-row-id="{{ row.id }}">
                                        <td class="text-center">{{ row.row_number }}</td>
                                        {% for column, data_type in columns.items %}
                                            <td class="editable-cell" 
                                                data-row-id="{{ row.id }}" 
                                                data-column="{{ column }}"
                                                data-original-value="{{ row.data|get_item:column|default:'' }}">
                                                {% with value=row.data|get_item:column %}
                                                    <span class="cell-content">
                                                        {% if value %}
                                                            {{ value }}
                                                        {% else %}
                                                            <em class="text-muted">NULL</em>
                                                        {% endif %}
                                                    </span>
                                                {% endwith %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="row align-items-center">
                <!-- Page Info -->
                <div class="col-md-6">
                    <div class="page-info">
                        Page <span id="current-page">{{ page_obj.number }}</span> of 
                        <span id="total-pages">{{ paginator.num_pages }}</span>
                        ({{ total_records }} total records)
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div class="col-md-6">
                    <nav aria-label="Table pagination">
                        <div class="d-flex justify-content-end align-items-center gap-2">
                            <!-- First/Previous -->
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" id="first-page" 
                                        {% if not page_obj.has_previous %}disabled{% endif %}>
                                    <i class="fas fa-angle-double-left"></i>
                                </button>
                                <button class="btn btn-outline-primary" id="prev-page"
                                        {% if not page_obj.has_previous %}disabled{% endif %}>
                                    <i class="fas fa-angle-left"></i>
                                </button>
                            </div>

                            <!-- Page Input -->
                            <div class="input-group" style="width: 120px;">
                                <input type="number" id="page-input" class="form-control form-control-sm text-center"
                                       value="{{ page_obj.number }}" min="1" max="{{ paginator.num_pages }}">
                            </div>

                            <!-- Next/Last -->
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" id="next-page"
                                        {% if not page_obj.has_next %}disabled{% endif %}>
                                    <i class="fas fa-angle-right"></i>
                                </button>
                                <button class="btn btn-outline-primary" id="last-page"
                                        {% if not page_obj.has_next %}disabled{% endif %}>
                                    <i class="fas fa-angle-double-right"></i>
                                </button>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading...</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <!-- Table Editing JavaScript -->
    <script>
        // Global state
        let modifiedCells = new Map();
        let currentSort = { column: '{{ sort_by }}', order: '{{ sort_order }}' };
        let currentPage = {{ page_obj.number }};
        let totalPages = {{ paginator.num_pages }};
        let pageSize = {{ page_size }};
        let filterText = '{{ filter_text }}';
        
        // Initialize table functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeTableEditing();
            initializeFiltering();
            initializeSorting();
            initializePagination();
            initializeToolbar();
            updatePendingChanges();
        });

        // Cell editing functionality
        function initializeTableEditing() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    if (!this.classList.contains('editing')) {
                        enterEditMode(this);
                    }
                });
            });
        }

        function enterEditMode(cell) {
            if (cell.classList.contains('editing')) return;
            
            const cellContent = cell.querySelector('.cell-content');
            const originalValue = cell.dataset.originalValue || '';
            const currentValue = cellContent.textContent.trim();
            
            cell.classList.add('editing');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-input';
            input.value = currentValue === 'NULL' ? '' : currentValue;
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            // Handle input events
            input.addEventListener('blur', () => exitEditMode(cell, input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    exitEditMode(cell, input);
                } else if (e.key === 'Escape') {
                    exitEditMode(cell, input, true);
                }
            });
        }

        function exitEditMode(cell, input, cancel = false) {
            const newValue = cancel ? cell.dataset.originalValue : input.value;
            const originalValue = cell.dataset.originalValue || '';
            const rowId = cell.dataset.rowId;
            const column = cell.dataset.column;
            
            cell.classList.remove('editing');
            
            // Restore cell content
            const span = document.createElement('span');
            span.className = 'cell-content';
            span.textContent = newValue || 'NULL';
            
            if (!newValue) {
                span.innerHTML = '<em class="text-muted">NULL</em>';
            }
            
            cell.innerHTML = '';
            cell.appendChild(span);
            
            // Track changes
            if (!cancel && newValue !== originalValue) {
                modifiedCells.set(`${rowId}-${column}`, {
                    rowId,
                    column,
                    originalValue,
                    newValue
                });
                cell.classList.add('modified-cell');
            } else {
                modifiedCells.delete(`${rowId}-${column}`);
                cell.classList.remove('modified-cell');
            }
            
            updatePendingChanges();
        }

        // Filter functionality
        function initializeFiltering() {
            const filterInput = document.getElementById('filter-input');
            const clearFilter = document.getElementById('clear-filter');
            
            let filterTimeout;
            
            filterInput.addEventListener('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    filterText = this.value;
                    currentPage = 1;
                    reloadTable();
                }, 500);
            });
            
            clearFilter.addEventListener('click', function() {
                filterInput.value = '';
                filterText = '';
                currentPage = 1;
                reloadTable();
            });
        }

        // Sorting functionality
        function initializeSorting() {
            document.querySelectorAll('.sort-header').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.dataset.column;
                    const currentSortOrder = this.dataset.currentSort;
                    
                    // Toggle sort order
                    let newOrder = 'asc';
                    if (currentSort.column === column) {
                        newOrder = currentSort.order === 'asc' ? 'desc' : 'asc';
                    }
                    
                    currentSort = { column, order: newOrder };
                    currentPage = 1;
                    reloadTable();
                });
            });
        }

        // Pagination functionality
        function initializePagination() {
            const firstPage = document.getElementById('first-page');
            const prevPage = document.getElementById('prev-page');
            const nextPage = document.getElementById('next-page');
            const lastPage = document.getElementById('last-page');
            const pageInput = document.getElementById('page-input');
            const pageSizeSelect = document.getElementById('page-size');
            
            firstPage.addEventListener('click', () => goToPage(1));
            prevPage.addEventListener('click', () => goToPage(Math.max(1, currentPage - 1)));
            nextPage.addEventListener('click', () => goToPage(Math.min(totalPages, currentPage + 1)));
            lastPage.addEventListener('click', () => goToPage(totalPages));
            
            pageInput.addEventListener('change', function() {
                const page = parseInt(this.value);
                if (page >= 1 && page <= totalPages) {
                    goToPage(page);
                } else {
                    this.value = currentPage;
                }
            });
            
            pageSizeSelect.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                reloadTable();
            });
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                reloadTable();
            }
        }

        // Toolbar functionality
        function initializeToolbar() {
            const saveButton = document.getElementById('save-changes');
            const undoButton = document.getElementById('undo-changes');
            const reloadButton = document.getElementById('reload-table');
            
            saveButton.addEventListener('click', saveChanges);
            undoButton.addEventListener('click', undoAllChanges);
            reloadButton.addEventListener('click', () => {
                if (modifiedCells.size > 0) {
                    if (confirm('You have unsaved changes. Reloading will lose these changes. Continue?')) {
                        modifiedCells.clear();
                        reloadTable();
                    }
                } else {
                    reloadTable();
                }
            });
        }

        // Save changes
        async function saveChanges() {
            if (modifiedCells.size === 0) return;
            
            showLoading();
            
            try {
                const changes = Array.from(modifiedCells.values());
                
                for (const change of changes) {
                    const response = await fetch(`{% url 'csv_upload:update_cell' csv_upload.id %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            row_id: change.rowId,
                            column: change.column,
                            value: change.newValue
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                
                // Clear modifications and update UI
                document.querySelectorAll('.modified-cell').forEach(cell => {
                    cell.classList.remove('modified-cell');
                    // Update original value
                    const key = `${cell.dataset.rowId}-${cell.dataset.column}`;
                    if (modifiedCells.has(key)) {
                        cell.dataset.originalValue = modifiedCells.get(key).newValue;
                    }
                });
                
                modifiedCells.clear();
                updatePendingChanges();
                showToast('Changes saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving changes:', error);
                showToast('Error saving changes. Please try again.', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Undo all changes
        function undoAllChanges() {
            if (modifiedCells.size === 0) return;
            
            if (confirm('Are you sure you want to undo all unsaved changes?')) {
                modifiedCells.forEach((change, key) => {
                    const [rowId, column] = key.split('-');
                    const cell = document.querySelector(`[data-row-id="${rowId}"][data-column="${column}"]`);
                    if (cell) {
                        const span = cell.querySelector('.cell-content');
                        if (span) {
                            const originalValue = change.originalValue;
                            span.textContent = originalValue || 'NULL';
                            if (!originalValue) {
                                span.innerHTML = '<em class="text-muted">NULL</em>';
                            }
                        }
                        cell.classList.remove('modified-cell');
                    }
                });
                
                modifiedCells.clear();
                updatePendingChanges();
                showToast('All changes undone', 'info');
            }
        }

        // Reload table data
        async function reloadTable() {
            showLoading();
            
            const params = new URLSearchParams({
                filter: filterText,
                sort: currentSort.column,
                order: currentSort.order,
                page: currentPage,
                page_size: pageSize
            });
            
            try {
                const response = await fetch(`{% url 'csv_upload:reload_table_data' csv_upload.id %}?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    updateTableContent(data);
                    updatePaginationInfo(data);
                    updateSortHeaders();
                } else {
                    showToast('Error loading data', 'danger');
                }
                
            } catch (error) {
                console.error('Error reloading table:', error);
                showToast('Error loading data', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Update table content
        function updateTableContent(data) {
            const tableBody = document.getElementById('table-body');
            const columns = {{ columns|safe }};
            
            let html = '';
            data.table_data.forEach(row => {
                html += `<tr data-row-id="${row.id}">`;
                html += `<td class="text-center">${row.row_number}</td>`;
                
                Object.keys(columns).forEach(column => {
                    const value = row.data[column] || '';
                    const displayValue = value || '<em class="text-muted">NULL</em>';
                    
                    html += `<td class="editable-cell" 
                                data-row-id="${row.id}" 
                                data-column="${column}"
                                data-original-value="${value}">
                                <span class="cell-content">${displayValue}</span>
                             </td>`;
                });
                html += '</tr>';
            });
            
            tableBody.innerHTML = html;
            
            // Reinitialize editing
            initializeTableEditing();
            
            // Update total records
            document.getElementById('total-records').textContent = data.total_records;
        }

        // Update pagination info
        function updatePaginationInfo(data) {
            currentPage = data.current_page;
            totalPages = data.total_pages;
            
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('page-input').value = currentPage;
            document.getElementById('page-input').max = totalPages;
            
            // Update button states
            const firstBtn = document.getElementById('first-page');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const lastBtn = document.getElementById('last-page');
            
            firstBtn.disabled = currentPage <= 1;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            lastBtn.disabled = currentPage >= totalPages;
        }

        // Update sort headers
        function updateSortHeaders() {
            document.querySelectorAll('.sort-header').forEach(header => {
                const column = header.dataset.column;
                const icon = header.querySelector('.sort-icon');
                
                header.classList.remove('active');
                icon.classList.remove('active');
                
                if (currentSort.column === column) {
                    header.classList.add('active');
                    icon.classList.add('active');
                    header.dataset.currentSort = currentSort.order;
                    
                    // Update icon
                    icon.className = `fas sort-icon active ${currentSort.order === 'asc' ? 'fa-sort-up' : 'fa-sort-down'}`;
                } else {
                    icon.className = 'fas fa-sort sort-icon';
                    header.dataset.currentSort = '';
                }
            });
        }

        // Update pending changes UI
        function updatePendingChanges() {
            const pendingDiv = document.getElementById('pending-changes');
            const pendingCount = document.getElementById('pending-count');
            const saveButton = document.getElementById('save-changes');
            const undoButton = document.getElementById('undo-changes');
            
            const count = modifiedCells.size;
            
            if (count > 0) {
                pendingDiv.style.display = 'block';
                pendingCount.textContent = count;
                saveButton.disabled = false;
                undoButton.disabled = false;
            } else {
                pendingDiv.style.display = 'none';
                saveButton.disabled = true;
                undoButton.disabled = true;
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('toast');
            const toastBody = document.getElementById('toast-body');
            
            toastBody.textContent = message;
            toastElement.className = `toast bg-${type}${type === 'danger' ? ' text-white' : ''}`;
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                   '{{ csrf_token }}';
        }

        // Firefox compatibility and error handling
        if (typeof window.FormHistory !== 'undefined') {
            try {
                window.addEventListener('error', function(e) {
                    if (e.message && e.message.includes('Form history is disabled')) {
                        e.preventDefault();
                        return true;
                    }
                });
            } catch (err) {
                console.log('Form history handling not available');
            }
        }
        
        if ('indexedDB' in window) {
            window.addEventListener('error', function(e) {
                if (e.message && e.message.includes('IndexedDB')) {
                    e.preventDefault();
                    console.log('IndexedDB error suppressed for Firefox compatibility');
                    return true;
                }
            });
        }
        
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.toString().includes('sentry')) {
                e.preventDefault();
                console.log('External service CORS error suppressed');
            }
        });
        
        if (navigator.userAgent.includes('Firefox')) {
            console.log('Firefox detected - optimizing table display');
            
            const tableContainers = document.querySelectorAll('.table-container');
            tableContainers.forEach(function(container) {
                container.style.scrollBehavior = 'smooth';
            });
        }
    </script>
</body>
</html>
